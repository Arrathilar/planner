{% extends 'base.html' %}
{% load staticfiles %}
{% load mptt_tags %}
{% load widget_tweaks %}
{% load ita_template_tags %}


{% block context %}
    <div class="page-container page-content-inner page-container-bg-solid" xmlns="http://www.w3.org/1999/html"
         xmlns="http://www.w3.org/1999/html">
        <!-- BEGIN CONTENT -->
        <div class="container-fluid container-lf-space">
            <!-- BEGIN PAGE BASE CONTENT -->
            <div class="row widget-row margin-top-20">
                <!-- PERMISSION CHECK -->
                {% if perms.planner.change_deal %}
                <form id="DealForm" class="form-horizontal" action="" enctype="multipart/form-data" method="post">{% csrf_token %}
                <div class="col-md-7">
                    <!-- BEGIN WIDGET TAB -->
                    <div class="widget-bg-color-white widget-tab">
                        <ul class="nav nav-tabs">
                            {% if deal.pk %}
                                <li class="active">
                                    <a href="#tab_1_1" data-toggle="tab">Редагувати договір</a>
                                </li>
                                <li>
                                    <a href="#tab_1_2" data-toggle="tab"> Інформація по договору </a>
                                </li>
                            {% else %}
                                <li class="active">
                                    <a href="#tab_1_1" data-toggle="tab">Додати договір</a>
                                </li>
                            {% endif %}
                        </ul>
                        <div class="tab-content" data-handle-color="#D7DCE2">
                            <div class="tab-pane fade active in" id="tab_1_1">
                                    <table class="table table-hover">
                                        <col width="25%">
                                        {{ form }}
                                    </table>
                            </div>
                            {% if deal.pk %}
                            <div class="tab-pane fade" id="tab_1_2">
                                    <table class="table table-hover">
                                        <col width="25%">
                                        <tr><th><p>Вартість договору по роботам:</p></th>
                                            <th><p><strong>{{ deal.value_calc }} грн.</strong></p></th>
                                        </tr>
                                        <tr><th><p>Бонуси по договору:</p></th>
                                            <th><p><strong>{{ deal.bonuses_calc }} грн.</strong></p></th>
                                        </tr>
                                        <tr>
                                            <th><p>Витрати по договору:</p></th>
                                            <th><p><strong>{{ deal.costs_calc }} грн.</strong></p></th>
                                        </tr>
                                        <tr>
                                            <th><p>Дата оплати:</p></th>
                                            <th><p><strong>{{ deal.pay_date_calc }}</strong></p></th>
                                        </tr>
                                    </table>
                            </div>
                            {% endif %}
                            <div class="form-actions">
                                        {% if deal.pk %}<a href="{% url 'deal_delete' deal.pk %}?{{ filters }}"
                                                        class="btn red btn-sm btn-outline sbold uppercase">Видалити</a>
                                        {% else %}<a href="{% url 'deal_list' %}?{{ filters }}"
                                                        class="btn red btn-sm btn-outline sbold uppercase">Відмінити</a>
                                        {% endif %}
                                        <button type="submit" class="btn dark btn-sm btn-outline sbold uppercase"
                                                style="float: right;">Зберегти</button>
                            </div>
                        </div>
                    </div>
                    <!-- END WIDGET -->
                </div>
                <div class="col-md-5 col-sm-12 col-xs-12  margin-top-sm-20">
                    <!-- BEGIN WIDGET TAB -->
                    <div class="portlet light tasks-widget">
                        <div class="text-center">
                            <div class="caption caption-md font-red-sunglo">
                                <span class="caption-subject theme-font bold uppercase"> Проекти </span>
                            </div>
                        </div>
                    </div>
                        <div id="parentWrapper" class="tab-content" style="height: max-content;" data-handle-color="#D7DCE2">
                            {{ tasks_formset.non_form_errors }}
                            <!--check the length of the formset-->
                            <!--if formset is not empty-->
                            {% if tasks_formset|length %}
                            {% for form in tasks_formset %}
                            <div class="portlet light margin-top-20">
                                <table id="TasksTable" class="table table-hover">
                                    <col width="25%">
                                    <tbody>
                                        {% for hidden_field in form.hidden_fields %}
                                        {{ hidden_field }}
                                        {% endfor %}
                                        {{ form }}
                                    </tbody>
                                </table>
                            </div>
                            {% endfor %}
                            <!--if formset is empty-->
                            {% else %}
                            <div style="display: none" id="tasks_formset">
                                <div class="portlet light margin-top-20">
                                    <table id="TasksTableEmptyForm" class="table table-hover task-formset">
                                        <col width="25%">
                                            {% for hidden_field in form.hidden_fields %}
                                            {{ hidden_field }}
                                        <tbody>
                                            {% endfor %}
                                            {{ tasks_formset.empty_form }}
                                        </tbody>
                                    </table>
                                </div>
                                <button id="0 formset" style="display: none" type="button" class="delete-formset btn red btn-sm btn-outline margin-bottom-20 float-right">Видалити проект</button>
                            </div>
                            <button type="button" class="add-formset btn dark btn-sm btn-outline padding-bottom-20">Додати проект</button>
                            {% endif %}
                            {{ tasks_formset.management_form }}
                        </div>
                    </div>
                    <!-- END PORTLET-->
                </form>
                {% else %}
                    Ви не маєте доступу до редагування даного проекту<br><br>
                {% endif %}
            </div>
            <!-- END PAGE BASE CONTENT -->
        </div>
        <!-- END CONTENT -->
    </div>
    <!-- END CONTAINER -->
{% endblock %}

{% block css %}
<link rel="stylesheet" type="text/css" href="/static/admin/css/forms.css"/>
{% endblock css %}

{% block extrahead %}
<script>
window.onload = function () {
    const addBtn = document.querySelector('.add-formset');
    const updateManagement = document.querySelector('#id_task_set-TOTAL_FORMS');
    const hiddenTemplate = document.querySelector('#tasks_formset');
    const lastFormset = document.querySelectorAll('#tasks_formset:last-of-type')[0]
    addBtn.addEventListener('click', () => {
        if (updateManagement.attributes.value.value > 0) {
            addFormsets(lastFormset, 'common');
        } else {
            changeManagement(updateManagement, 'Add formset');
            addFormsets(lastFormset, 'initial');
        }
    })


    function changeManagement(element, event) {
        if (event == 'Add formset') {
            let id = ++element.attributes.value.value;
            element.attributes.setValue = id;
        } else if (event == 'Delete formset') {
            let id = --element.attributes.value.value;
            element.attributes.setValue = id;
        }
    }

    function addFormsets (formset, event) {
        if (event == 'initial') {
            hiddenTemplate.setAttribute('style', '')
        } else if (event == 'common') {
            let cloneFormset = formset.cloneNode(true);
            let labels = cloneFormset.querySelectorAll('div > table > tbody > tr > th > label');
            changeLabelId(labels)
        }
    }

    function changeLabelId(element) {
        let id = 0
        id+=  //error this
        element.forEach(function (element, ndx) {
            let getLabelFor = element.attributes.for.value;
            let splitFor = getLabelFor.split('-');
            splitFor[1] = id;
            let newForString = splitFor.join('-');
            element.setAttribute('for', newForString);
            console.log(element)
        });
    };
}
</script>
<script>
    //     let updateElement = document.querySelectorAll('#TasksTableEmptyForm > tbody > tr > td > input');
    //     let updateSelect = document.querySelectorAll('#TasksTableEmptyForm > tbody > tr > td > select');
    //     let updateLabel = document.querySelectorAll('#TasksTableEmptyForm > tbody > tr > th > label');
    //     let updateManagement = document.querySelector('#id_task_set-TOTAL_FORMS')
    //     let baseId = '0';
    //     let addBtn = document.querySelector('.add-formset');
    //     let deleteBtn = document.querySelector('.delete-formset:last-of-type'); //node list
    //     let wrapperFormset = document.querySelector('#tasks_formset');
    //     let parentWrapper = document.querySelector('#parentWrapper');

    //     addBtn.addEventListener('click', () => {
    //         changeFormsets(updateManagement, 'Initial formset');
    //         addFormset(wrapperFormset, parentWrapper, baseId);
    //     }, {once: false});

    //     // deleteBtn.forEach(function () {
    //     //     deleteBtn.addEventListener('click', () => {
    //     //     deleteFormset(wrapperFormset);
    //     // }, {once: false});
    //     // })


    //     if (updateElement == undefined || updateSelect == undefined || updateLabel == undefined) {
    //         console.error('Not find label, select or input in form. Check variables');
    //     } else {
    //         changeLabelId(updateLabel, baseId);

    //         // function ChangeAttrs(element, selectElem, id) {
    //         //     id++
    //         //     element.forEach(function (element, ndx) {
    //         //         if (element == null) {
    //         //             console.error('Function ChangeAttrs return: ' + element);
    //         //         } else {
    //         //             let attrNameVal = element.attributes.name.value;
    //         //             let splitNameVal = attrNameVal.split('-');
    //         //             splitNameVal[1] = id;
    //         //             console.log(splitNameVal)
    //         //             let newValString = splitNameVal.join('-');
    //         //             element.setAttribute('name', newValString);
    //         //             if (element.hasAttribute('id')) {
    //         //                 let attrIdVal = element.attributes.id.value;
    //         //                 let splitIdVal = attrNameVal.split('-');
    //         //                 splitIdVal[1] = id;
    //         //                 let newIdString = splitIdVal.join('-');
    //         //                 element.setAttribute('id', newIdString);
    //         //             };
    //         //         };
    //         //     });

    //         //     selectElem.forEach(function (element, ndx) {
    //         //         if (element == null) {
    //         //             console.error('Function ChangeAttrs return: ' + element + '. Check function ChangeAttrs');
    //         //         } else {
    //         //             let attrNameVal = element.attributes.name.value;
    //         //             let splitNameVal = attrNameVal.split('-');
    //         //             splitNameVal[1] = id;
    //         //             let newValString = splitNameVal.join('-');
    //         //             element.setAttribute('name', newValString);
    //         //             if (element.hasAttribute('id')) {
    //         //                 let attrIdVal = element.attributes.id.value;
    //         //                 let splitIdVal = attrNameVal.split('-');
    //         //                 splitIdVal[1] = id;
    //         //                 let newIdString = splitIdVal.join('-');
    //         //                 element.setAttribute('id', newIdString);
    //         //             };
    //         //         };
    //         //     });
    //         // };
    //     };

    //     let lastAddBtn = document.querySelectorAll('.add-formset');
    //     lastAddBtn = lastAddBtn[lastAddBtn.length - 1];
    //     if (lastAddBtn == null) {
    //         console.error('Element not find, check function updateNdx');
    //     } else {
    //         // lastAddBtn.addEventListener('click', updateNdx);

    //         function updateNdx() {
                
    //         };
    //     };

    //     function changeLabelId (element, id) {
    //         element.forEach(function (element, ndx) {
    //             let getLabelFor = element.attributes.for.value;
    //             let splitFor = getLabelFor.split('-');
    //             splitFor[1] = id;
    //             let newForString = splitFor.join('-');
    //             element.setAttribute('for', newForString);
    //         });
    //     };

    //     function changeFormsets (element, event) {
    //         if (event == 'Add formset') {
    //             let id = ++element.attributes.value.value;
    //             element.attributes.setValue = id;
    //         }
    //         else if (event == 'Initial formset') {
    //             // changeLabelId()
    //         }
            
    //     }
        

    //     function addFormset(wrapperId, parentWrapper, baseId) {
    //         let hiddenForm = document.querySelector('#tasks_formset');
    //         hiddenForm.setAttribute('style', '');
    //         let deleteBtn = document.querySelectorAll('.delete-formset:last-of-type')[0];
    //         let baseIdForDelBtn = deleteBtn.attributes.id.value;
    //         baseIdForDelBtn = parseInt(baseIdForDelBtn, 10);
    //         baseIdForDelBtn = ++baseIdForDelBtn
    //         deleteBtn.setAttribute('id', baseIdForDelBtn);
    //         deleteBtn.setAttribute('style', '');
    //         if (updateManagement.value == 0) {
    //             updateManagement.value = 1
    //             updateManagement.setAttribute('value', '1');
    //         } else if (updateManagement.value != 0) {
    //             let newFormset = wrapperId.cloneNode(true);
    //             parentWrapper.insertBefore(newFormset, addBtn)
    //             let increasedVal = ++updateManagement.value;
    //             updateManagement.setAttribute('value', increasedVal);
    //         }
    //         let allFormsets = document.querySelectorAll('#TasksTableEmptyForm');
    //         let lastFormset = allFormsets[allFormsets.length - 1]
    //         lastFormsetVal = lastFormset.querySelectorAll('tbody > tr > td > input')[0].attributes.name.value
    //         getNameVal = lastFormsetVal.split('-');
    //         if (getNameVal[1] == '__prefix__') {
    //             getNameVal[1] = 0;
    //         } else {
    //             ++getNameVal[1];
    //         };
    //         let newValString = getNameVal.join('-');
    //         console.log(newValString)

    //         // let getPrevLabel = document.querySelectorAll('#TasksTableEmptyForm:last-of-type > tbody > tr > th > label')
    //         // let id = document.querySelectorAll('#tasks_formset:last-of-type > div > table > tbody > tr > td > input')[0].attributes.name.value
    //         // let prevIdVal = id.split('-')[1];
    //         // prevIdVal++;
    //         // // changeLabelId(getPrevLabel, prevIdVal);
    //         // let parentElem = document.querySelectorAll('#tasks_formset:last-of-type > div > table > tbody > tr > td > input');
    //         // parentElem.forEach(function (element, ndx) {
    //         //     let attrNameVal = element.attributes.name.value;
    //         //     let splitNameVal = attrNameVal.split('-');
    //         //     splitNameVal[1] = prevIdVal;
    //         //     let newNameString = splitNameVal.join('-');
    //         //     element.setAttribute('name', newNameString);
    //         //     if (element.hasAttribute('id')) {
    //         //         let attrIdVal = element.attributes.id.value;
    //         //         let splitIdVal = attrNameVal.split('-');
    //         //         splitIdVal[1] = prevIdVal;
    //         //         let newIdString = splitIdVal.join('-');
    //         //         element.setAttribute('id', newIdString);
    //         //     };
    //         // });
    //     };

        

    //     function deleteFormset(wrapperFormset) {
    //         console.log('delete')
    //     }
    // };

</script>

<script type="text/javascript">
    window.onerror = function (msg) {
        $("body").attr("JSError", msg);
    }

$(document).ready(function(){
  $('[data-toggle="tooltip"]').tooltip();
});
</script>
<script src="{% static 'dynamic_formsets/jquery.formset.js' %}" type="text/javascript"></script>
<script type="text/javascript" src="{% url 'javascript-catalog' %}"></script>
<script type="text/javascript" src="/static/admin/js/core.js"></script>

{% endblock %}